<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sala de Válvulas - Pack OW</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { background: "#0f172a", foreground: "#f8fafc", primary: "#f97316", secondary: "#1e293b", warning: "#eab308", success: "#22c55e", destructive: "#ef4444", info: "#3b82f6" },
                    animation: { 'slide-down': 'slideDown 0.3s ease-out forwards' },
                    keyframes: { slideDown: { '0%': { transform: 'translateY(-100%)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }
        .card-industrial { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; }
        .input-industrial { background-color: #334155; border: 1px solid #475569; color: white; border-radius: 0.5rem; padding: 0.75rem; width: 100%; outline: none; }
        .btn-industrial { border-radius: 0.5rem; font-weight: 600; text-transform: uppercase; transition: all 0.2s; }
        .btn-industrial:active { transform: scale(0.95); }
        .valve-jumpeada { border-color: #eab308 !important; color: #eab308 !important; background-color: rgba(234, 179, 8, 0.1) !important; }
        .valve-op-ativa { border-color: #3b82f6 !important; box-shadow: 0 0 10px rgba(59, 130, 246, 0.3); }
        .ticker-wrap { width: 100%; overflow: hidden; background-color: rgba(0, 0, 0, 0.3); border-top: 1px solid #334155; padding: 8px 0; white-space: nowrap; position: absolute; bottom: 0; left: 0; border-bottom-left-radius: 0.75rem; border-bottom-right-radius: 0.75rem; }
        .ticker-move { display: inline-block; white-space: nowrap; animation: ticker-loop 30s linear infinite; }
        .ticker-item { display: inline-block; padding: 0 2rem; color: #fbbf24; font-weight: 600; font-size: 0.85rem; font-family: 'JetBrains Mono', monospace; }
        @keyframes ticker-loop { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        #toast-container { position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); z-index: 100; width: 90%; max-width: 400px; pointer-events: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="sticky top-0 z-40 bg-[#0f172a]/95 border-b border-[#334155] backdrop-blur p-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <h1 class="text-lg font-bold uppercase tracking-wider">SALA DE <span class="text-primary">VÁLVULAS</span></h1>
            <div class="flex bg-secondary rounded-lg p-1 gap-1">
                <button onclick="setMode('register')" id="tab-register" class="px-3 py-2 rounded-md text-sm font-semibold">Registro</button>
                <button onclick="setMode('history')" id="tab-history" class="px-3 py-2 rounded-md text-sm font-semibold">Histórico</button>
            </div>
        </div>
    </header>

    <main id="main-container" class="flex-1 p-4 pb-24 max-w-7xl mx-auto w-full"></main>
    <div id="toast-container"></div>

    <div id="custom-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 opacity-0 transition-all duration-200">
        <div class="card-industrial w-full max-w-sm transform scale-95 transition-all flex flex-col max-h-[85vh]" id="modal-panel">
            <div class="p-5 border-b border-gray-700 flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-bold uppercase">Título</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="modal-content" class="p-5 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyA61zwT-_IG0r6B_0GcgUzCjsGct1d_DXI", authDomain: "sala-valvulas-ow-163b3.firebaseapp.com", projectId: "sala-valvulas-ow-163b3", storageBucket: "sala-valvulas-ow-163b3.firebasestorage.app", messagingSenderId: "845901302642", appId: "1:845901302642:web:84871bdbcfcf97bf886beb" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let globalDB = {}, opportunitiesDB = {};
        let state = { mode: 'register', step: 'line', selectedLine: null, selectedValve: null, selectedSubset: null, sondaAction: 'jumper', sondaStatusAtual: 'ok', form: { type: 'corretiva', description: '', status: 'ok', kronesDiag: '', shift: '' }, sondaForm: { obs: '', op: '' }, filters: { line: 'all', valve: '', historyType: 'all' } };
        const LINE_CONFIGS = { '512': { valveCount: 175, subsets: ['V1', 'V2', 'V3', 'V5', 'V6', 'V7', 'V8'], hasProbe: true }, '513': { valveCount: 175, subsets: ['V1', 'V2', 'V3', 'V4', 'V5', 'V6', 'V7'], hasProbe: true }, '514': { valveCount: 72, subsets: null, hasProbe: false } };

        // UI
        function showToast(msg, type='error') {
            const c = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `${type==='error'?'bg-red-600':'bg-green-600'} text-white px-4 py-3 rounded-lg shadow-lg mb-2 flex items-center gap-3 animate-slide-down`;
            el.innerHTML = `<i data-lucide="${type==='error'?'alert-circle':'check-circle'}" class="w-5 h-5"></i><span class="text-sm font-bold">${msg}</span>`;
            c.appendChild(el); lucide.createIcons();
            setTimeout(() => { el.remove(); }, 3000);
        }
        function openModal(t, h) { const m=document.getElementById('custom-modal'); document.getElementById('modal-title').innerText=t; document.getElementById('modal-content').innerHTML=h; m.classList.remove('hidden'); setTimeout(()=>{m.classList.remove('opacity-0');document.getElementById('modal-panel').classList.add('scale-100');},10); lucide.createIcons(); }
        function closeModal() { const m=document.getElementById('custom-modal'); m.classList.add('opacity-0'); document.getElementById('modal-panel').classList.remove('scale-100'); setTimeout(()=>{m.classList.add('hidden');},200); }
        function showOptionPicker(t, opts, cb) { window.pickerCB=cb; const h=opts.map(o=>`<button onclick="window.pickerCB('${o.value}');closeModal();" class="w-full text-left p-4 rounded-lg bg-secondary border border-gray-700 mb-2 hover:border-primary flex justify-between font-bold text-gray-200">${o.label}</button>`).join(''); openModal(t, h); }
        
        // NOVO: Modal de Exclusão de Dois Níveis
        function showDeleteChoice(l, v, id) {
            const h = `
                <div class="space-y-4">
                    <p class="text-xs text-gray-400 uppercase font-bold text-center">Nível 1: Administrativo</p>
                    <button onclick="confirmAction('hide','${l}','${v}','${id}')" class="w-full btn-industrial bg-secondary border border-gray-600 text-white py-3">Ocultar do App (0608)</button>
                    
                    <div class="border-t border-gray-700 my-4 pt-4">
                        <p class="text-xs text-red-500 uppercase font-bold text-center">Nível 2: Destrutivo</p>
                        <button onclick="confirmAction('delete','${l}','${v}','${id}')" class="w-full btn-industrial bg-red-900/40 border border-red-600 text-red-500 py-3 mt-2">Excluir do Firebase (Senha Mestra)</button>
                    </div>
                </div>
            `;
            openModal("Gerenciar Registro", h);
        }

        // Função de confirmação com as duas senhas
        function confirmAction(type, l, v, id) {
            const promptHTML = `
                <div class="space-y-4 text-center">
                    <p class="text-sm text-gray-300">Digite a senha para ${type==='hide'?'Ocultar':'DELETAR'}:</p>
                    <input type="password" id="confirm-pwd" class="input-industrial text-center text-xl font-mono" placeholder="****">
                    <button onclick="executeAction('${type}','${l}','${v}','${id}')" class="btn-industrial w-full bg-primary text-white py-3">Confirmar</button>
                </div>
            `;
            openModal("Segurança", promptHTML);
        }

        async function executeAction(type, l, v, id) {
            const pass = document.getElementById('confirm-pwd').value;
            const ref = db.collection('lines').doc(l).collection('valves').doc(String(v));
            
            if(type === 'hide') {
                if(pass !== '0608') return showToast("Senha Incorreta");
                const s = await ref.get();
                if(s.exists) {
                    const newHist = s.data().historico.map(h => h.id === id ? {...h, oculto: true} : h);
                    await ref.update({historico: newHist});
                    showToast("Registro Ocultado", "success");
                }
            } else {
                if(pass !== 'Wilkerdiego@84') return showToast("Senha Mestra Incorreta");
                const s = await ref.get();
                if(s.exists) {
                    const newHist = s.data().historico.filter(h => h.id !== id);
                    await ref.update({historico: newHist});
                    showToast("Excluído Permanentemente", "success");
                }
            }
            closeModal();
        }

        function showPasswordPrompt(cb) { window.passCB=cb; openModal("Segurança", `<div class="text-center space-y-4"><input type="number" id="pwd" class="input-industrial text-center text-xl font-mono" placeholder="Senha"><button onclick="if(document.getElementById('pwd').value==='0608'){closeModal();window.passCB();}else{showToast('Erro');}" class="btn-industrial w-full bg-primary text-white py-3">Confirmar</button></div>`); }

        // RENDER
        function setMode(m) { state.mode=m; render(); }
        function navigateTo(s) { state.step=s; window.history.pushState({step:s},null,''); render(false); }
        function render(u=true) {
            const c=document.getElementById('main-container'); c.innerHTML='';
            document.getElementById('tab-register').className = state.mode==='register' ? "bg-primary text-white px-3 py-2 rounded-md" : "text-gray-400 px-3 py-2 rounded-md";
            document.getElementById('tab-history').className = state.mode==='history' ? "bg-primary text-white px-3 py-2 rounded-md" : "text-gray-400 px-3 py-2 rounded-md";
            if(state.mode==='register') renderRegister(c); else renderHistory(c);
            lucide.createIcons();
        }

        function renderRegister(c) {
            if(state.step==='line') {
                const html=Object.keys(LINE_CONFIGS).map(l=>{
                    const cfg=LINE_CONFIGS[l]; let pg=0, pt=0, co=0, j=[]; const ld=globalDB[l]||{}; Object.values(ld).forEach(v=>{ if(v.sonda_status==='jumpeada')j.push(v.valveNumber); if(v.historico)v.historico.forEach(h=>{ if(h.type==='preventiva'){ pt++; if(h.subset==='Geral')pg++; } if(h.type==='corretiva')co++; }); });
                    const ops=opportunitiesDB[l]||[];
                    return `<div class="card-industrial p-0 relative overflow-hidden mb-4"><div onclick="state.selectedLine='${l}';navigateTo('valve');" class="p-6 cursor-pointer"><h2 class="text-2xl font-bold font-mono">Linha ${l}</h2><div class="grid grid-cols-2 gap-2 mt-2 text-xs font-mono"><div>Meta: ${cfg.valveCount-pg}</div><div class="text-green-500">Prev: ${pt}</div><div class="text-red-500">Corr: ${co}</div>${j.length?`<div class="col-span-2 text-yellow-500 font-bold mt-1">Sondas (${j.length}): ${j.sort((a,b)=>a-b).join(', ')}</div>`:''}</div></div><button onclick="openOpModal('${l}')" class="absolute top-2 right-2 p-2 bg-secondary rounded-full border border-gray-600"><i data-lucide="list-plus" class="text-yellow-500"></i></button><div class="ticker-wrap"><div class="ticker-move">${ops.map(o=>`<span class="ticker-item">⚠️ V${o.valvula}: ${o.texto}</span>`).join('')}</div></div></div>`;
                }).join('');
                c.innerHTML=html;
            } else if(state.step==='valve') {
                const cnt=LINE_CONFIGS[state.selectedLine].valveCount; let b=''; for(let i=1;i<=cnt;i++)b+=`<button id="vbtn-${i}" onclick="state.selectedValve=${i};navigateTo(LINE_CONFIGS[state.selectedLine].subsets?'subset':'form');" class="card-industrial aspect-square flex items-center justify-center font-bold">${i}</button>`;
                c.innerHTML=`<div class="grid grid-cols-4 gap-3">${b}</div>`; loadGrid();
            } else if(state.step==='subset') {
                const cfg=LINE_CONFIGS[state.selectedLine];
                c.innerHTML=`<div class="space-y-3"><button onclick="checkSonda()" class="card-industrial p-4 w-full text-yellow-500 font-bold">GESTÃO DE SONDA</button>${cfg.subsets.map(s=>`<button onclick="state.selectedSubset='${s}';navigateTo('form');" class="card-industrial p-5 w-full text-left font-bold">${s}</button>`).join('')}<button onclick="state.selectedSubset='Geral';navigateTo('form');" class="card-industrial p-5 w-full text-left font-bold text-primary">Válvula Completa</button></div>`;
            } else if(state.step==='sonda_form') {
                const isJ=state.sondaStatusAtual==='jumpeada';
                c.innerHTML=`<div class="space-y-4"><div class="p-4 rounded-lg bg-secondary font-bold text-center ${isJ?'text-red-500':'text-green-500'}">Status: ${isJ?'JUMPEADA':'NORMAL'}</div><div class="grid grid-cols-2 gap-2"><button onclick="state.sondaAction='jumper';render(false);" class="p-4 rounded bg-secondary font-bold border ${state.sondaAction==='jumper'?'border-yellow-500':''}">JUMPER</button>${isJ?`<button onclick="state.sondaAction='normalizar';render(false);" class="p-4 rounded bg-secondary font-bold border ${state.sondaAction==='normalizar'?'border-yellow-500':''}">NORMALIZAR</button>`:''}</div><textarea oninput="state.sondaForm.obs=this.value" class="input-industrial" placeholder="Motivo">${state.sondaForm.obs}</textarea><input oninput="state.sondaForm.op=this.value" class="input-industrial" placeholder="Nome" value="${state.sondaForm.op}"><button onclick="openSmartTurnoPicker('st-txt')" class="input-industrial text-left flex justify-between items-center"><span id="st-txt">${state.form.shift||'Turno...'}</span><i data-lucide="chevron-down"></i></button><button onclick="submitSonda()" class="btn-industrial bg-yellow-600 text-white py-4 w-full">Salvar</button></div>`;
            } else if(state.step==='form') {
                c.innerHTML=`<div class="space-y-4"><h2 class="text-xl font-bold">L${state.selectedLine} V${state.selectedValve} - ${state.selectedSubset||'Geral'}</h2><div class="grid grid-cols-3 gap-2"><button onclick="setType('corretiva')" class="p-3 rounded bg-secondary border ${state.form.type==='corretiva'?'border-red-500':''}">Corr</button><button onclick="setType('preventiva')" class="p-3 rounded bg-secondary border ${state.form.type==='preventiva'?'border-green-500':''}">Prev</button><button onclick="setType('inspecao')" class="p-3 rounded bg-secondary border ${state.form.type==='inspecao'?'border-orange-500':''}">Insp</button></div><textarea oninput="state.form.description=this.value" class="input-industrial" rows="3" placeholder="Descrição">${state.form.description}</textarea><button onclick="submitForm()" class="btn-industrial bg-primary text-white py-4 w-full">Salvar</button></div>`;
            }
        }

        function renderHistory(c) {
            c.innerHTML=`<div class="space-y-4"><div class="card-industrial p-4 grid grid-cols-2 gap-2"><div><label class="text-[10px] uppercase">Linha</label><button onclick="showOptionPicker('Linha',[{label:'Todas',value:'all'},{label:'512',value:'512'},{label:'513',value:'513'},{label:'514',value:'514'}],v=>{state.filters.line=v;render();})" class="w-full text-left p-2 rounded bg-secondary text-sm">${state.filters.line}</button></div><div><label class="text-[10px] uppercase">Tipo</label><button onclick="showOptionPicker('Tipo',[{label:'Tudo',value:'all'},{label:'Manutenções',value:'manutencao'},{label:'Pendentes',value:'ops_abertas'}],v=>{state.filters.historyType=v;render();})" class="w-full text-left p-2 rounded bg-secondary text-sm">${state.filters.historyType}</button></div></div><div id="h-list" class="space-y-2"></div></div>`;
            const el=document.getElementById('h-list'); let res=[]; const lines=(state.filters.line==='all')?Object.keys(LINE_CONFIGS):[state.filters.line];
            
            if(state.filters.historyType!=='ops_abertas') {
                lines.forEach(l=>{ 
                    Object.values(globalDB[l]||{}).forEach(v=>{ 
                        // FILTRO: Não mostra itens marcados como ocultos
                        if(v.historico)v.historico.forEach(h=>{ if(!h.oculto) res.push({...h,line:l,valve:v.valveNumber}); }); 
                    }); 
                });
            }
            if(state.filters.historyType==='ops_abertas') lines.forEach(l=>{ (opportunitiesDB[l]||[]).forEach(o=>res.push({id:o.id,isOp:true,line:l,valve:o.valvula,description:`PENDENTE: ${o.texto}`,timestamp:new Date().toISOString()})); });
            res.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
            el.innerHTML=res.map(r=>`<div class="card-industrial p-4 relative ${r.isOp?'border-blue-500':''}"><div class="flex justify-between font-bold text-primary"><span>L${r.line}/V${r.valve}</span><button onclick="${r.isOp?'askDelOp(\''+r.id+'\')':'showDeleteChoice(\''+r.line+'\',\''+r.valve+'\',\''+r.id+'\')'}" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div><p class="text-sm mt-1">${r.description}</p></div>`).join('');
        }

        // LOGIC
        db.collection('oportunidades').onSnapshot(s=>{ opportunitiesDB={}; s.forEach(d=>{ const data=d.data(); if(!opportunitiesDB[data.linha])opportunitiesDB[data.linha]=[]; opportunitiesDB[data.linha].push({id:d.id,...data}); }); render(false); });
        Object.keys(LINE_CONFIGS).forEach(l=>db.collection('lines').doc(l).collection('valves').onSnapshot(s=>{ if(!globalDB[l])globalDB[l]={}; s.forEach(d=>{ globalDB[l][d.id]=d.data(); }); render(false); }));

        function setType(t){ if(t==='preventiva') showPasswordPrompt(()=>{state.form.type=t;render(false);}); else {state.form.type=t;render(false);} }
        function openSmartTurnoPicker(id){ showOptionPicker("Turno",[{label:'Manhã',value:'Manhã'},{label:'Tarde',value:'Tarde'},{label:'Noite',value:'Noite'}],v=>{state.form.shift=v;const el=document.getElementById(id);el.innerText=v;el.className="text-white font-bold";}); }
        function checkSonda(){ const d=globalDB[state.selectedLine]?.[state.selectedValve]||{}; state.sondaStatusAtual=d.sonda_status||'ok'; navigateTo('sonda_form'); }

        async function submitSonda() {
            const {obs,op}=state.sondaForm; if(!obs||!op||!state.form.shift)return showToast("Faltam dados");
            const typeRec=state.sondaAction==='jumper'?'sonda_event':'corretiva'; const status=state.sondaAction==='jumper'?'jumpeada':'ok';
            const rec={id:Date.now().toString(),timestamp:new Date().toISOString(),subset:'SONDA',type:typeRec,description:`[SONDA] ${state.sondaAction.toUpperCase()}: ${obs} (Op: ${op}/${state.form.shift})`,status:'ok'};
            await db.collection('lines').doc(state.selectedLine).collection('valves').doc(String(state.selectedValve)).set({valveNumber:parseInt(state.selectedValve),historico:firebase.firestore.FieldValue.arrayUnion(rec),sonda_status:status},{merge:true});
            showToast("Salvo","success"); state.sondaForm.obs=''; navigateTo('line');
        }

        async function submitForm(){
            if(!state.form.description) return showToast("Falta descrição");
            const rec={id:Date.now().toString(),timestamp:new Date().toISOString(),subset:state.selectedSubset||'Geral',type:state.form.type,description:state.form.description,status:state.form.status};
            await db.collection('lines').doc(state.selectedLine).collection('valves').doc(String(state.selectedValve)).set({valveNumber:parseInt(state.selectedValve),historico:firebase.firestore.FieldValue.arrayUnion(rec)},{merge:true});
            showToast("Salvo","success"); state.form.description=''; navigateTo('line');
        }

        function askDelOp(id){ showPasswordPrompt(async()=>{ await db.collection('oportunidades').doc(id).delete(); showToast("Excluído","success"); }); }

        function openOpModal(l) {
            const subs=(LINE_CONFIGS[l].subsets||[]).concat(['Geral']);
            const h=`<div class="space-y-3"><input type="number" id="ov" class="input-industrial" placeholder="Válvula"><button onclick="showOptionPicker('Item',window.tempSubs.map(s=>({label:s,value:s})),v=>{document.getElementById('os').value=v;document.getElementById('ob').innerText=v;})" id="ob" class="input-industrial text-left">Item...</button><input type="hidden" id="os"><input id="on" class="input-industrial" placeholder="Nome"><button onclick="showOptionPicker('Turno',[{label:'Manhã',value:'Manhã'},{label:'Tarde',value:'Tarde'},{label:'Noite',value:'Noite'}],v=>{document.getElementById('ot').value=v;document.getElementById('tb').innerText=v;})" id="tb" class="input-industrial text-left">Turno...</button><input type="hidden" id="ot"><textarea id="ox" class="input-industrial" placeholder="Defeito"></textarea><button onclick="saveOp('${l}')" class="btn-industrial bg-primary text-white w-full py-3">Salvar</button><div id="ol" class="space-y-2 mt-4"></div></div>`;
            window.tempSubs=subs; openModal("Oportunidades", h); renderOpsList(l);
        }
        function renderOpsList(l){ const el=document.getElementById('ol'); const ops=opportunitiesDB[l]||[]; el.innerHTML=ops.map(o=>`<div class="p-2 bg-secondary rounded border border-gray-700 flex justify-between"><div>V${o.valvula}: ${o.texto}</div><button onclick="doDone('${l}','${o.id}',${o.valvula},'${o.subset}','${o.texto}')" class="text-green-500"><i data-lucide="check-square"></i></button></div>`).join(''); lucide.createIcons(); }
        async function saveOp(l){
            const v=document.getElementById('ov').value,s=document.getElementById('os').value,n=document.getElementById('on').value,t=document.getElementById('ot').value,x=document.getElementById('ox').value;
            if(!v||!s||!n||!t||!x) return showToast("Faltam dados");
            await db.collection('oportunidades').add({linha:l,valvula:parseInt(v),subset:s,nome:n,turno:t,texto:x});
            closeModal(); showToast("Registrado","success");
        }
        async function doDone(l,id,v,s,x){
            openModal("Baixa",`<div class="space-y-3"><input id="bq" class="input-industrial" placeholder="Quem fez?"><textarea id="bo" class="input-industrial" placeholder="Solução"></textarea><button onclick="confirmDone('${l}','${id}',${v},'${s}','${x}')" class="btn-industrial bg-green-600 text-white w-full py-3">Concluir</button></div>`);
        }
        async function confirmDone(l,id,v,s,x){
            const q=document.getElementById('bq').value,o=document.getElementById('bo').value; if(!q||!o)return;
            const rec={id:Date.now().toString(),timestamp:new Date().toISOString(),subset:s,type:'corretiva',description:`[OP] ${x} | Sol: ${o} (Exec: ${q})`,status:'ok'};
            await db.collection('lines').doc(l).collection('valves').doc(String(v)).set({valveNumber:v,historico:firebase.firestore.FieldValue.arrayUnion(rec)},{merge:true});
            await db.collection('oportunidades').doc(id).delete(); closeModal(); showToast("Baixado","success");
        }
        function loadGrid(){ const d=globalDB[state.selectedLine]||{}; const ops=opportunitiesDB[state.selectedLine]||[]; const opV=new Set(ops.map(o=>o.valvula)); const cnt=LINE_CONFIGS[state.selectedLine].valveCount; for(let i=1;i<=cnt;i++){ const b=document.getElementById(`vbtn-${i}`); if(b){ b.classList.remove('valve-jumpeada','valve-op-ativa'); if(d[i]?.sonda_status==='jumpeada')b.classList.add('valve-jumpeada'); if(opV.has(i))b.classList.add('valve-op-ativa'); } } }
        render();
    </script>
</body>
</html>

